//
// init
//
var 	gpio		= require('onoff').Gpio,
	led		= new gpio(14, 'out'),
	request		= require('request'),
	Q		= require('q'),
	clientURL	= 'http://192.168.1.105:4000/alive';

//
// definition of routes
//
exports.index = function(req, res){
	console.log("/index");
	res.render('index');
};

exports.ledOn = function(req, res){
	console.log("/on");
	led.writeSync(1);
	console.log("client up: " + clientUp(clientURL));
	res.render('computer');
};

exports.ledOff = function(req, res){
	console.log("/off");
	led.writeSync(0);
	res.render('index');
};

exports.order = function(req, res){
	console.log("/order");
	var params = '';
	for(var param in req.query){
		params += req.query[param] + " ";
	}
	console.log(params);
	res.render('index');
};

function clientUp(url){
	console.log('client up and running ? - ' + url);

	var deferred = Q.defer();

	request(url, function(error, response, body){

		if(!error && response.statusCode == 200){
			console.log('status: ' + response.statusMessage);
			deferred.resolve();
		}
		else{
			console.log('error: ' + err);
			deferred.reject();
		}

	});

	return deferred.promise;
}
